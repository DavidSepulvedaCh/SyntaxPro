---
import { route } from "../utils/routes";

interface Lesson {
  id: string;
  type: string;
  title: string;
  url: string;
}

interface Props {
  title: string;
  description: string;
  thumbnail: string;
  progress: number;
  locked?: boolean;
  lessons?: Lesson[];
}

const {
  title,
  description,
  thumbnail,
  progress,
  locked = false,
  lessons = [],
} = Astro.props;

// Helper to process lesson URLs with base path
const processLessonUrl = (lesson: Lesson) => {
  // If it's an internal route (starts with /), add base path
  if (lesson.url.startsWith("/") && !lesson.url.startsWith("http")) {
    return route(lesson.url.slice(1)); // Remove leading slash
  }
  return lesson.url;
};
---

<div class="course-card" class:list={[{ locked }]}>
  <div class="image-container">
    <img src={thumbnail} alt={title} />
    {
      locked && (
        <div class="locked-overlay">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
          </svg>
          <span>MÃ³dulo bloqueado</span>
        </div>
      )
    }
    {
      !locked && (
        <div class="overlay">
          <span class="progress-badge">{progress}% Completado</span>
        </div>
      )
    }
  </div>
  <div class="content">
    <h3>{title}</h3>
    <p>{description}</p>

    {
      !locked && lessons.length > 0 && (
        <div class="lessons-list">
          {lessons.map((lesson) => (
            <a
              href={processLessonUrl(lesson)}
              target={lesson.type === "forum" ? "_self" : "_blank"}
              class="lesson-item"
              data-type={lesson.type}
              download={
                lesson.type === "pdf" || lesson.type === "activity"
                  ? true
                  : undefined
              }
            >
              {lesson.type === "zoom" && (
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polygon points="23 7 16 12 23 17 23 7" />
                  <rect x="1" y="5" width="15" height="14" rx="2" ry="2" />
                </svg>
              )}
              {lesson.type === "pdf" && (
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                  <polyline points="14 2 14 8 20 8" />
                </svg>
              )}
              {lesson.type === "activity" && (
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                  <polyline points="14 2 14 8 20 8" />
                  <line x1="16" y1="13" x2="8" y2="13" />
                  <line x1="16" y1="17" x2="8" y2="17" />
                  <polyline points="10 9 9 9 8 9" />
                </svg>
              )}
              {lesson.type === "forum" && (
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                </svg>
              )}
              <span>{lesson.title}</span>
            </a>
          ))}
        </div>
      )
    }

    {
      !locked && lessons.length > 0 && (
        <div class="progress-bar">
          <div class="progress-fill" style={`width: ${progress}%`} />
        </div>
      )
    }
  </div>
</div>

<style>
  .course-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    overflow: hidden;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .course-card:not(.locked):hover {
    transform: translateY(-5px);
    box-shadow:
      0 20px 25px -5px rgba(0, 0, 0, 0.1),
      0 10px 10px -5px rgba(0, 0, 0, 0.04);
    border-color: #cbd5e1;
  }

  .course-card.locked {
    opacity: 0.7;
  }

  .image-container {
    position: relative;
    height: 180px;
    overflow: hidden;
  }

  .image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .course-card:not(.locked):hover .image-container img {
    transform: scale(1.05);
  }

  .locked-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 23, 42, 0.8);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
  }

  .locked-overlay svg {
    color: white;
  }

  .locked-overlay span {
    color: white;
    font-weight: 600;
    font-size: 0.95rem;
  }

  .overlay {
    position: absolute;
    top: 10px;
    right: 10px;
  }

  .progress-badge {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(4px);
    color: var(--color-primary);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .content {
    padding: 1.5rem;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-dark);
  }

  p {
    margin: 0 0 1.25rem 0;
    color: var(--color-text-light);
    font-size: 0.95rem;
    line-height: 1.5;
  }

  .lessons-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1.25rem;
  }

  .lesson-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 8px;
    text-decoration: none;
    color: var(--color-text);
    font-size: 0.9rem;
    transition: all 0.2s ease;
    border: 1px solid transparent;
  }

  .lesson-item:hover {
    background: #f1f5f9;
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .lesson-item svg {
    flex-shrink: 0;
    color: var(--color-primary);
  }

  .lesson-item span {
    line-height: 1.4;
  }

  .lesson-item[data-type="zoom"] svg {
    color: #2d8cff;
  }

  .lesson-item[data-type="pdf"] svg {
    color: #dc2626;
  }

  .lesson-item[data-type="activity"] svg {
    color: #16a34a;
  }

  .lesson-item[data-type="forum"] svg {
    color: #8b5cf6;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: #e2e8f0;
    border-radius: 10px;
    overflow: hidden;
    margin-top: auto;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary) 0%, #60a5fa 100%);
    border-radius: 10px;
    transition: width 0.3s ease;
  }
</style>
